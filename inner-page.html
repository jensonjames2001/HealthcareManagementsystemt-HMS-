<!DOCTYPE html>
<html>

<head>
    <title>WELCOME TO HEALTH SERVICES</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        .container {
            max-width: 600px;
            margin: 20px auto;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #ff6666;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            color: white;
        }

        .form-header img {
            height: 40px;
        }

        .form-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .input-group-addon {
            min-width: 50px;
        }

        .btn-default {
            margin-top: 10px;
        }

        #qr-reader {
            width: 100%;
            margin: 20px 0;
        }

        .checkbox label {
            padding-left: 20px;
        }

        .checkbox input {
            margin-left: -20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="form-header">
            <h2>Register Here!</h2>
            <img src="assets/img/logo.png" alt="Company Logo">
        </div>
        <form class="well form-horizontal" action="https://script.google.com/macros/s/AKfycbwn_xKRj38RlUe3J4hlOcqWP1y7CAtqohW-Tk9qKfAN/dev" method="post" id="contact_form">
            <fieldset>

                <div class="form-group">
                    <label class="col-md-4 control-label">Select service:</label>
                    <div class="col-md-8 selectContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-list"></i></span>
                            <select name="driver" class="form-control selectpicker" id="driver">
                                <option value="">Select Services</option>
                                <option>Book an Appointment</option>
                                <option>Report a problem</option>
                                <option>Repeat a prescription</option>
                                <option></option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Enter illness:</label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-home"></i></span>
                            <input name="vehicle_registration" id="vehicle_registration" placeholder="Ex: LM58WBE" class="form-control" type="text">
                            <button type="button" class="btn btn-default" onclick="openQRScanner('vehicle_registration')">Scan QR</button>
                        </div>
                    </div>
                </div>
<!--
                <div id="qr-reader"></div>
                <div id="qr-reader-results"></div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Enter Start Time:</label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
                            <input name="start_time" id="start_time" class="form-control" type="time">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Enter End Time:</label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-time"></i></span>
                            <input name="end_time" class="form-control" type="time" id="end_time">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Start </label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-road"></i></span>
                            <input name="start_mileage" id="start_mileage" placeholder="Start Mileage" class="form-control" type="text">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">End </label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-road"></i></span>
                            <input name="end_mileage" id="end_mileage" placeholder="End Mileage" class="form-control" type="text">
                        </div>
                    </div>
                </div>
                <br>

                <div class="form-group">
                    <label class="col-md-4 control-label">ULEZ Charge:</label>
                    <div class="col-md-8">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="ulez_charge" value="ulez">
                                ULEZ Charge
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Congestion Charge:</label>
                    <div class="col-md-8">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="congestion_charge" value="congestion">
                                Congestion Charge
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Airport Drop-off Charge:</label>
                    <div class="col-md-8">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="airport_dropoff_charge" value="airport_dropoff">
                                Airport Drop-off Charge
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Airport Parking Charge:</label>
                    <div class="col-md-8">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="airport_parking_charge" value="airport_parking">
                                Airport Parking Charge
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label">Car Parking Charge:</label>
                    <div class="col-md-8">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" name="car_parking_charge" value="car_parking">
                                Car Parking Charge
                            </label>
                        </div>
                    </div>
                </div>
-->
                <div class="form-group">
                    <label class="col-md-4 control-label">Describe illness:</label>
                    <div class="col-md-8 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-pencil"></i></span>
                            <textarea class="form-control" name="expense_description" id="expense_description" placeholder="Describe the expense"></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-md-4 control-label"></label>
                    <div class="col-md-8">
                        <button type="button" class="btn btn-warning" onclick="sendToWhatsApp();">SUBMIT <span class="glyphicon glyphicon-send"></span></button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>

    <script>
        function openQRScanner(inputId) {
            const html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: 250
                },
                qrCodeMessage => {
                    document.getElementById(inputId).value = qrCodeMessage;
                    if (inputId === 'vehicle_registration') {
                        const qrData = JSON.parse(qrCodeMessage);
                        document.getElementById('vehicle_registration').value = qrData.vehicleReg;
                        document.getElementById('start_time').value = qrData.startTime;
                    }
                    html5QrCode.stop().then(ignore => {
                        document.getElementById('qr-reader').style.display = 'none';
                    }).catch(err => {
                        console.error(err);
                    });
                },
                errorMessage => {
                    console.log(`QR Code no longer in front of camera.`);
                }
            ).catch(err => {
                console.log(`Unable to start scanning, error: ${err}`);
            });
        }

        function sendToWhatsApp() {
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/x-www-form-urlencoded");

            var driver = document.querySelector("select[name='driver']").value;
            var vehicleReg = document.querySelector("input[name='vehicle_registration']").value;
            var startTime = document.querySelector("input[name='start_time']").value;
            var endTime = document.querySelector("input[name='end_time']").value;
            var startMileage = document.querySelector("input[name='start_mileage']").value;
            var endMileage = document.querySelector("input[name='end_mileage']").value;
            var expenseDescription = document.querySelector("textarea[name='expense_description']").value;

            var urlencoded = new URLSearchParams();
            urlencoded.append("token", "ca7ig1mupxuwhwg4");
            urlencoded.append("to", "+447440644232");
            urlencoded.append("body", `
                Driver: ${driver}
                Vehicle Reg: ${vehicleReg}
                Start Time: ${startTime}
                End Time: ${endTime}
                Start Mileage: ${startMileage}
                End Mileage: ${endMileage}
                Expense Description: ${expenseDescription}
                ${document.querySelector("input[name='ulez_charge']").checked ? 'ULEZ Charge: Yes' : ''}
                ${document.querySelector("input[name='congestion_charge']").checked ? 'Congestion Charge: Yes' : ''}
                ${document.querySelector("input[name='airport_dropoff_charge']").checked ? 'Airport Drop-off Charge: Yes' : ''}
                ${document.querySelector("input[name='airport_parking_charge']").checked ? 'Airport Parking Charge: Yes' : ''}
                ${document.querySelector("input[name='car_parking_charge']").checked ? 'Car Parking Charge: Yes' : ''}
            `);
            urlencoded.append("priority", "10");
            urlencoded.append("referenceId", "");
            urlencoded.append("msgId", "");
            urlencoded.append("mentions", "");

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: urlencoded,
                redirect: 'follow'
            };

            fetch("https://api.ultramsg.com/instance60030/messages/chat", requestOptions)
                .then(response => response.text())
                .then(result => console.log(result))
                .catch(error => console.log('error', error));
        }

        document.addEventListener("DOMContentLoaded", function () {
            const url = "https://script.google.com/macros/s/AKfycbwn_xKRj38RlUe3J4hlOcqWP1y7CAtqohW-Tk9qKfAN/dev"; // enter your public ('access' - 'anyone') deployment URL (NOT test deployment!)
            document.getElementById('contact_form').action = url;

            // Fetching the data from each column in the sheet
            // then populating the respective datalist
            fetch(`${url}?header=driver`) // Fetch data for the "Name" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("driver", data); // Use "your-name" as the id
                })
                .catch((error) => console.error('!!!!!!!!', error));

            fetch(`${url}?header=vehicle_registration`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("vehicle_registration", data); // Use "VehicleReg" as the id
                })
                .catch((error) => console.error('!!!!!!!!', error));

            fetch(`${url}?header=start_time`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("start_time", data); // Use "VehicleReg" as the id
                });

            fetch(`${url}?header=end_time`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("end_time", data); // Use "VehicleReg" as the id
                });

            fetch(`${url}?header=start_mileage`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("start_mileage", data); // Use "VehicleReg" as the id
                });

            fetch(`${url}?header=end_mileage`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("end_mileage", data); // Use "VehicleReg" as the id
                });

            fetch(`${url}?header=expense_description`) // Fetch data for the "VehicleReg" field
                .then((response) => response.json())
                .then(({ data }) => {
                    console.log(data);
                    populateDatalists("expense_description", data); // Use "VehicleReg" as the id
                });

            // Function to add options to datalists
            const populateDatalists = (id, arr) => {
                let result = '';
                for (const item of arr) {
                    result += `<option value="${item}">`;
                }
                document.getElementById(id).innerHTML = result;
            }
        });
    </script>
</body>

</html>
